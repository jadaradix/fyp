/*!
 * csv
 * Copyright(c) 2015 James Garner
 * MIT Licensed
 */

var _ = require("underscore");

function csv() {

  var _self = this;

  _self.fromObjects = function (dObjects, fields, writeIndex) {
    if (writeIndex) fields.unshift("index");
    var data = [
      (function(fields) {
        var r = {};
        _.each(fields, function(field) {
          r[field] = field;
        });
        return r;
      } (fields))
    ].concat(
      (writeIndex ? _.map(dObjects, function(dObject, index) {
        var r = dObject;
        r["index"] = index;
        return r;
      }) : dObjects)
    );
    var csvRows = _.map(data, function(dataElement, index) {
      var fieldValues = _.map(fields, function(field) {
        return ((field in dataElement) ? (dataElement[field].toString().replace(/,/g, " ")) : "?");
      });
      return fieldValues.join(",");
    });
    var csv = csvRows.join("\n");
    return csv;
  }

}

module.exports = new csv();