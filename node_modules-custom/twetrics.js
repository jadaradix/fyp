/*!
 * twetrics
 * Copyright(c) 2015 James Garner
 * MIT Licensed
 */

var _ = require("underscore");
var _s = require("underscore.string");
var moment = require("moment");

function twetrics() {

  var _self = this;

  //from http://stackoverflow.com/a/8837505
  _self.sortByKey = function(array, key) {
    return array.sort(function(a, b) {
      var x = a[key]; var y = b[key];
      return ((x < y) ? -1 : ((x > y) ? 1 : 0));
    });
  }

  _self.abstractCount = function(data, property) {
    var totals = [];
    _.each(data, function(dataElement) {
      var total = _.find(totals, function(total) {
        if (total.name == dataElement[property]) return total;
      });
      if (total) {
        total.count++;
      } else {
        var nDataElement = dataElement;
        nDataElement["count"] = 1;
        totals.push(nDataElement);
      }
    });
    totals = _self.sortByKey(totals, "count").reverse();
    return totals;
  }

  _self.abstractCollect = function(data, key) {
    var r = [];
    _.each(data, function(dataElement) {
      if (!dataElement) return;
      r = r.concat(dataElement[key]);
    });
    return r;
  }

  _self.formatString = function(string, values) {
    _.each(values, function(valueElement, index) {
      var sIndex = "%" + index.toString();
      var sElement = valueElement.toString();
      string = string.replace(sIndex, sElement);
    });
    return string;
  }

  _self.formatStrings = function(dObject, values) {
    return {
      "name": dObject.name,
      "headline": _self.formatString(dObject.headlineFormat, values),
      "subtext": _self.formatString(dObject.subtextFormat, values),
      "values": values
    }
  }

  _self.metrics = [

    {
      "name": "bestFriends",
      "headlineFormat": "%0 and %1",
      "subtextFormat": "Your best friends on Twitter are %0 and %1",
      "method": function(tweets) {
        var allMentions = _self.abstractCollect(tweets, "mentions");
        var totals = _self.abstractCount(allMentions, "name").splice(0, 2);
        var totalNames = _.pluck(totals, "name");
        return _self.formatStrings(this, totalNames);
      }
    },

    {
      "name": "topHashtags",
      "headlineFormat": "%0, %1 and %2",
      "subtextFormat": "Your top hashtags are %0, %1 and %2",
      "values": [],
      "method": function(tweets) {
        var allHashtags = _self.abstractCollect(tweets, "hashtags");
        allHashtags = _.map(allHashtags, function(hashtag) {
          return {
            "value": "#" + hashtag
          };
        });
        var totals = _self.abstractCount(allHashtags, "value").splice(0, 3);
        var totalValues = _.pluck(totals, "value");
        return _self.formatStrings(this, totalValues);
      }
    },

    {
      "name": "tweetTimes",
      "headlineFormat": "%1 days",
      "subtextFormat": "You've tweeted %0 times in the past %1 days",
      "method": function(tweets) {
        var earliestDate = moment();
        var latestDate = moment("1900-01-01");
        var allWhens = _.pluck(tweets, "when").map(function(when) {
          return moment(when, "III MMM DD HH:mm:ss +ZZ YYYY");
        });
        _.each(allWhens, function(when) {
          if (when.isBefore(earliestDate)) earliestDate = when;
          if (when.isAfter(latestDate)) latestDate = when;
        });
        var difference = latestDate.diff(earliestDate, "days");
        var values = [tweets.length, difference];
        return _self.formatStrings(this, values);
      }
    },

    {
      "name": "retweetPercentage",
      "headlineFormat": "%0%",
      "subtextFormat": "%0% of your tweets are retweets",
      "method": function(tweets) {
        var retweetCount = _.filter(tweets, function(tweet) {
          return tweet.isRetweet;
        }).length;
        var decimal = retweetCount / tweets.length;
        var percentage = Math.floor(decimal * 100);
        var values = [percentage];
        return _self.formatStrings(this, values);
      }
    },

  ];

}

module.exports = new twetrics();